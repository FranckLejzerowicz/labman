{% extends sitebase.html %}

{% block head %}
<link rel="stylesheet" href="/static/vendor/css/bootstrap-select.min.css" type="text/css"/>
<script src="/static/vendor/js/bootstrap-select.min.js" type="text/javascript"></script>

<script type='text/javascript'>
  function prepareRun() {
    var postParams = {'pool': $('#pool-list').val(),
                      'run_name': $('#run-name').val(),
                      'sequencer': $('#seq-select').val(),
                      'fwd_cycles': $('#fwd-input').val(),
                      'rev_cycles': $('#rev-input').val(),
                      'assay': $('#assay-input').val(),
                      'principal_investigator': $('#pi-select').val(),
                      'additional_contacts': $('#contact-select').val()}
    $.post('/process/sequencing', postParams, function(data) {
      bootstrapAlert('Information saved. Download sample sheet <a href="/process/sequencing/' + data.process + '/sample_sheet">here</a>', 'success');
      $("html, body").animate({
        scrollTop: 0
      }, 500);
    })
      .fail(function (jqXHR, textStatus, errorThrown) {
        bootstrapAlert(jqXHR.responseText, 'danger');
      });
  };

  function submitChecks() {
    $('#submit-btn').prop('disabled', !(($('#run-name').val() !== '') &&
                                        ($('#pool-list').children().length > 0) &&
                                        ($('#seq-select').val() !== '') &&
                                        ($('#fwd-input').val() !== '') &&
                                        ($('#rev-input').val() !== '') &&
                                        ($('#assay-input').val() !== '') &&
                                        ($('#pi-select').val() !== '')));
  };

  function addPool(poolId) {
    // Check if number of pools exceeds number of lanes.
    var pools = $('#pool-list').children().length;
    var lanes = $('#seq-select option:selected').attr('data-lanes');
    if (pools >= lanes) {
      alert('You may add up to ' + lanes + ' pools.');
      return;
    }

    // Check if select pool is duplicate.
    var duplicate = false;
    $('#pool-list').children().each(function() {
      if ($(this).attr('id') === 'pool-' + poolId) {
        duplicate = true;
      }
    });
    if (duplicate === true) {
      alert('You cannot add duplicate pools.');
      return;
    }

    // Add pool to pool list.
    var $aElem = $("<a>");
    $aElem.addClass('list-group-item');
    $aElem.attr('id', 'pool-' + poolId);
    $aElem.append('<label><h4>' + $("#pool-select option[value=" + poolId + "]").text() + '</h4></label>');
    var $buttonElem = $("<button class='btn btn-danger btn-circle pull-right' onclick='removePool(" + poolId + ");'>");
    $buttonElem.append("<span class='glyphicon glyphicon-remove'></span>")
    $aElem.append($buttonElem);
    $('#pool-list').append($aElem);
  };

  function removePool(poolId) {
    $('#pool-' + poolId).remove();
  };

  function addContact(email) {
    var $aElem = $("<a>");
    $aElem.addClass('list-group-item');
    $aElem.attr('id', 'contact-' + email);
    $aElem.append('<label><h4>' + email + '</h4></label>');
    var $buttonElem = $("<button class='btn btn-danger btn-circle pull-right' onclick='removeContact(\"" + email + "\");'>");
    $buttonElem.append("<span class='glyphicon glyphicon-remove'></span>")
    $aElem.append($buttonElem);
    $('#contact-list').append($aElem);
    $('[id="addBtnPlate' + email + '"]').prop('disabled', true);
    $('#addContactModal').modal('hide');
  };

  function removeContact(email) {
    $('[id="contact-' + email + '"]').remove();
    $('[id="addBtnPlate' + email + '"]').prop('disabled', false);
  };

  $(document).ready(function() {
    $('.labman-input').on('change', submitChecks);
    $('#pool-select').prop('disabled', true);
    $('#add-pool-btn').prop('disabled', true);

    var table = $('#searchPoolTable').DataTable(
      {'ajax': {'url': '/pool_list'},
       'columnDefs': [{'targets': -1,
                       'data': null,
                       'render': function(data, type, row, meta) {
                         return "<button class='btn btn-success btn-circle-small'><span class='glyphicon glyphicon-plus'></span></button>";
                       }
                      }]
      }
    );

    $('#searchPoolTable tbody').on('click', 'button', function() {
      addPool(table.row($(this).parents('tr')).data()[0]);
    });

    $('#searchContactTable').DataTable();

    $('#searchContactTable tbody').on('click', 'button', function() {
      addContact($(this).parents('tr').find('td:first').text());
    });

    $('#seq-select').on('change', function() {
      $('#pool-select').prop('disabled', false);
      $('#pool-select').prop('selectedIndex', 0);
      $('#add-pool-btn').prop('disabled', false);
      $('#pool-list').empty();
    });

    $('#pool-select').on('change', function() {
      addPool($(this).val());
    });
  });
</script>

{% end %}

{% block content %}
<label><h3>Sequencing run <span id="run-name-title"></span></h3></label>

<!-- Run name -->
<div class='form-group'>
  <label class='control-label'><h4>Run name:</h4></label>
  <input type='text' id='run-name' class='form-control labman-input' />
</div>

<!-- Sequencer -->
<div class='form-group'>
  <label class='control-label'><h4>Sequencer:</h4></label>
  <select id='seq-select' class='form-control selectpicker labman-input' data-live-search='true' title='Choose sequencer...'>
    {% for sequencer in sequencers %}
      <option value='{{sequencer['equipment_id']}}' data-lanes={{sequencer['lanes']}}>{{sequencer['external_id']}} ({{sequencer['lanes']}} lanes)</option>
    {% end %}
  </select>
</div>

<!-- Pools -->
<div id='pools-div' class='form-group'>
  <label class='control-label'><h4>Sequencing pools:</h4></label>
  <select id='pool-select' class='form-control selectpicker labman-input' data-live-search='true' title='Add pool...'>
    {% for pool in pools %}
      <option value='{{pool[0]}}'>{{pool[1]}}</option>
    {% end %}
  </select><br>
  <button id='add-pool-btn' class='btn btn-success' data-toggle='modal' data-target='#addPoolModal'><span class='glyphicon glyphicon-plus'></span> Add pool</button>
  <div id='pool-list'>
  </div>
</div>

<!-- Modal to add pool -->
<div class='modal fade' tabindex='-1' role='dialog' id='addPoolModal'>
  <div class='modal-dialog modal-lg'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>
        <h3>Add pool to lane</h3>
      </div>
      <div class='modal-body'>
        <table id="searchPoolTable" class="display" cellspacing="0" width="100%">
          <thead>
            <tr>
              <th>Pool id</th>
              <th>Pool name</th>
              <th>Add</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- fwd_cycles -->
<div class='form-group'>
  <label class='control-label'><h4>Forward cycles:</h4></label>
  <input type='number' id='fwd-input' class='form-control labman-input' min="0" value="0"/>
</div>

<!-- rev cycles -->
<div class='form-group'>
  <label class='control-label'><h4>Reverse cycles:</h4></label>
  <input type='number' id='rev-input' class='form-control labman-input' min="0" value="0"/>
</div>

<!-- assay -->
<div class='form-group'>
  <label class='control-label'><h4>Assay:</h4></label>
  <input type='text' id='assay-input' class='form-control labman-input' />
</div>

<!-- PI -->
<div class='form-group'>
  <label class='control-label'><h4>Principal investigator:</h4></label>
  <select id='pi-select' class='form-control selectpicker labman-input' data-live-search='true' title='Choose user...'>
    {% for email in users %}
      <option value='{{email}}'>{{email}}</option>
    {% end %}
  </select>
</div>

<!-- Additional contacts -->
<div id='contacts-div' class='form-group'>
  <label class='control-label'><h4>Additional contacts: </h4></label>
  <button id='add-contact-btn' class='btn btn-success' data-toggle='modal' data-target='#addContactModal'><span class='glyphicon glyphicon-plus'></span> Add contact</button>
  <div id='contact-list'>
  </div>
</div>

<!-- Modal to add additional contacts -->
<div class='modal fade' tabindex='-1' role='dialog' id='addContactModal'>
  <div class='modal-dialog modal-lg'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>
        <h3>Add additional contact</h3>
      </div>
      <div class='modal-body'>
        <table id="searchContactTable" class="display" cellspacing="0" width="100%">
          <thead>
            <tr>
              <th>Contact</th>
              <th>Add</th>
            </tr>
          </thead>
          <tbody>
            {% for email in users %}
              <tr>
                <td>{{email}}</td>
                <td><button id='addBtnPlate{{email}}' class='btn btn-success btn-circle-small'><span class='glyphicon glyphicon-plus'></span></button></td>
              </tr>
            {% end %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div>
  <button id='submit-btn' onclick="prepareRun();" class='btn btn-success' disabled><span class='glyphicon glyphicon-share'></span> Create</button>
</div>

{% end %}
